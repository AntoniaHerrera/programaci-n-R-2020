
#SCRIPT DEL LABORATORIO EVMM 2018 - FRANCISCO URDINEZ#

library(matching)
library(dyplr)
library(haven)
library(dplyr)
library(ggplot2)
library(broom)
library(av.plots)
library(MatchIt)


#1)
inequality <- read.csv("c:/Users/user/Dropbox/FRAN/PUC Chile/Summer School/2018/lab/inequality.csv")
attach(inequality)

names(inequality)

#2)
  #exploramos la relacion entre las variables, alguna seÃ±al?
ggplot(inequality, aes(x = Polity, y = Gini)) + geom_point()

  #rodamos la regresion
modelo1<-lm(Gini~Polity, data=inequality na.action=na.omit)
summary(modelo1)

  #vamos a explorar los residuos
"ANDY: TENES IDEA COMO PUEDO HACER PARA QUE EN VEZ DE NUMEROS IDENTIFICANDO LOS VALORES 
EXTREMOS HAYA ALGUN TAG, POR EJEMPLO DE LA VARIABLE CODE O COUNTRY"

par(mfrow = c(2, 2))  
plot(modelo1)

  #ahora lo hacemos manualmente
"ANDY: ACA ESTA EL PRIMER PROBLEMA. LOS MISSING DE LA REGRESION ME COMPLICAN
EL CALCULO DE LOS RESIDUOS Y FITTED VALUES"

inequality$predicted_1 <- predict(modelo1, na.action=na.omit)   # valores predichos
inequality$residuals_1 <- residuals(modelo1, na.action=na.omit) # residuos
inequality %>% select(Gini, predicted_1, residuals_1) %>% head()

ggplot(inequality, aes(x = Polity, y = Gini)) + 
  geom_point(aes(color=abs(residuals), size=abs(residuals))) + 
  scale_color_continuous(low = "red", mid = "blue", high = "red")+
  guides(color = FALSE, size = FALSE) + 
  geom_segment(aes(xend = Polity, yend = predicted), alpha=.2) +
  geom_smooth(method = "lm", se = FALSE, color = "lightgrey")  +
  theme_bw()


#3)
  #exploramos visualmente los datos
ggplot(inequality, aes(x = Polity, y = Gini)) + geom_point()
ggplot(inequality, aes(x = log(GDP), y = Gini)) + geom_point()

  #rodamos el modelo
modelo2<-lm(Gini~Polity+log(GDP), data=inequality na.action=na.omit)
summary(modelo2)

  #exploramos los residuos
par(mfrow = c(2, 2))  
plot(modelo2)

  #ahora lo hacemos manualmente
inequality$predicted_2 <- predict(modelo2, na.action=na.omit)   # valores predichos
inequality$residuals_2 <- residuals(modelo2, na.action=na.omit) # residuos
inequality %>% select(Gini, predicted_2, residuals_1, residuals_2) %>% head()

inequality %>% 
  gather(key = "iv", value = "x", -Polity, -predicted_2, -residuals_2) %>%  
  ggplot(aes(x = x, y = Gini)) +  
  geom_segment(aes(xend = x, yend = predicted_2), alpha = .2) +
  geom_point(aes(color = residuals_2)) +
  scale_color_gradient2(low = "red", mid = "blue", high = "red") +
  guides(color = FALSE) +
  geom_point(aes(y = predicted_2), shape = 1) +
  facet_grid(~ iv, scales = "free_x") +
  theme_bw()





